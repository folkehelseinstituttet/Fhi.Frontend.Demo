@if (items) {
  <div class="fhi-tree-view-checkbox">
    @if (enableFilter) {
      <ng-container *ngTemplateOutlet="searchInput"></ng-container>
      @if (itemsFilteredIsLoading) {
        <div class="fhi-tree-view-checkbox__result-list">
          <div class="spinner-border ms-5" role="status"></div>
        </div>
      }
    }

    @if (!itemsFilteredIsLoading) {
      <div
        [ngClass]="{ 'fhi-tree-view-checkbox__result-list': itemsFilteredIsLoaded }"
        [ngStyle]="{ height: resultListHeight, 'max-height': resultListMaxHeight }"
        #resultListWrapper
      >
        @if (itemsFilteredIsLoaded && itemsFiltered?.length === 0) {
          <p>Ingen treff</p>
        } @else {
          <ng-container
            *ngTemplateOutlet="
              checkboxItems;
              context: {
                items: itemsFilteredIsLoaded ? itemsFiltered : items,
                listID: itemsFilteredIsLoaded ? instanceID : null,
                searched: ($searchTerm | async) !== '',
                toplevel: true,
              }
            "
          ></ng-container>
        }
      </div>
    }
  </div>
}

<ng-template #searchInput>
  <div class="fhi-tree-view-checkbox__search fhi-search mb-5">
    @if (filterLabel) {
      <label [for]="'search-input-' + instanceID" class="form-label" [id]="'search-input-label-' + instanceID">
        {{ filterLabel }}
      </label>
    }

    <div class="d-flex">
      <div class="w-100 position-relative">
        <input
          [id]="'search-input-' + instanceID"
          type="search"
          class="form-control fhi-search__form-control"
          placeholder="{{ placeholder }}"
          (ngModelChange)="onSearchTermChange($event)"
          [ngModel]="searchTerm"
          [attr.aria-controls]="'list-' + instanceID"
        />
      </div>
    </div>
  </div>
</ng-template>
<ng-template #checkboxItems let-items="items" let-listID="listID" let-searched="searched" let-toplevel="toplevel">
  <ul
    #checkboxList
    class="fhi-tree-view-checkbox__list"
    role="tree"
    [attr.id]="listID !== null ? 'list-' + listID : null"
    aria-live="polite"
  >
    @if (enableCheckAll && (!searched || toplevel)) {
      <button
        type="button"
        class="btn fhi-tree-view-checkbox__check-all"
        (click)="toplevel || (listID && searched) ? handleRecursiveSelection(items) : handleLevelSelection(items)"
      >
        {{ getButtonText(items, listID, toplevel) }}
      </button>
    }

    @for (item of items; track item) {
      <li class="fhi-tree-view-checkbox__item" role="treeitem">
        @if (item.children && !itemsFilteredIsLoaded) {
          <button
            class="fhi-tree-view-checkbox__toggler"
            [attr.aria-label]="'Toggle ' + item.name"
            [attr.aria-controls]="'list-' + item.internal?.id"
            [attr.aria-haspopup]="'tree'"
            [attr.aria-expanded]="item.isExpanded"
            (click)="toggleExpanded(item)"
          >
            <i
              [ngClass]="{
                'icon-dash-circle': item.isExpanded && !item.hasCheckedDescendant,
                'icon-plus-circle': !item.isExpanded && !item.hasCheckedDescendant,
                'icon-dash-circle-fill': item.isExpanded && item.hasCheckedDescendant,
                'icon-plus-circle-fill': !item.isExpanded && item.hasCheckedDescendant,
              }"
            >
            </i>
          </button>
        }

        @if (!singleSelection) {
          <div class="form-check mb-2">
            <input
              class="form-check-input"
              type="checkbox"
              value=""
              [id]="'check-input-' + item.internal?.id"
              [checked]="item.isChecked"
              (click)="toggleChecked(item.internal?.id)"
            />
            <label
              class="form-check-label"
              [for]="'check-input-' + item.internal?.id"
              [id]="'label-' + item.internal?.id"
              [innerHTML]="item.name"
            ></label>
          </div>
        } @else {
          <div class="form-check mb-2">
            <input
              class="form-check-input"
              type="radio"
              [name]="name"
              [id]="name + '-' + item.internal?.id"
              [checked]="item.isChecked"
              (change)="toggleChecked(item.internal?.id, false, false)"
            />
            <label
              class="form-check-label"
              [for]="name + '-' + item.internal?.id"
              [id]="'label-' + item.internal?.id"
              [innerHTML]="item.name"
            ></label>
          </div>
        }

        @if ((item.isExpanded && item.children) || (item.children && itemsFilteredIsLoaded)) {
          <div class="fhi-tree-view-checkbox__nested-group">
            <ng-container
              *ngTemplateOutlet="
                checkboxItems;
                context: { items: item.children, listID: item.internal?.id, searched: !!searched, toplevel: false }
              "
            ></ng-container>
          </div>
        }
      </li>
    }
  </ul>
</ng-template>
