<article *ngIf="diagramOptions !== undefined">
  <h1 class="h3 mb-3">{{ diagramOptions.title }}</h1>

  <div class="fhi-highcharts-nav">
    <div class="d-flex flex-wrap">
      <ng-container *ngIf="showDiagramTypeNav">
        <ng-container *ngTemplateOutlet="diagramTypeNav"></ng-container>
      </ng-container>

      <div class="fhi-highcharts-nav__standalone-btns">
        <ng-container *ngIf="showMetadataButton">
          <ng-container *ngTemplateOutlet="metadataLink"></ng-container>
        </ng-container>

        <ng-container *ngIf="showFullScreenButton">
          <ng-container *ngTemplateOutlet="diagramModal"></ng-container>
        </ng-container>
      </div>
    </div>
  </div>

  @if (showDiagramTypeDisabledWarning) {
    <ng-container *ngTemplateOutlet="diagramTypeDisabledWarning"></ng-container>
  } @else if (showDuplicateSerieNameError) {
    <ng-container *ngTemplateOutlet="duplicateSerieNameError"></ng-container>
  } @else {
    <ng-container *ngTemplateOutlet="diagramAndFooter"></ng-container>
  }
</article>

<ng-template #diagramAndFooter>
  <ng-container [ngSwitch]="activeDiagramTypeGroup?.name">
    <ng-container *ngSwitchCase="diagramTypeGroupNames?.table">
      <ng-container *ngTemplateOutlet="table"></ng-container>
    </ng-container>
    <ng-container *ngSwitchCase="diagramTypeGroupNames?.map">
      <ng-container *ngIf="showMap">
        <ng-container *ngTemplateOutlet="map"></ng-container>
      </ng-container>
    </ng-container>
    <ng-container *ngSwitchCase="diagramTypeGroupNames?.chart">
      <ng-container *ngIf="showDefaultChartTemplate; else chartAnimationHack">
        <ng-container *ngTemplateOutlet="chart"></ng-container>
      </ng-container>
      <!-- chartAnimationHack: to get correct chart animation when switching from one chart type to another -->
      <ng-template #chartAnimationHack>
        <ng-container *ngTemplateOutlet="chart"></ng-container>
      </ng-template>
    </ng-container>
  </ng-container>
  <ng-container *ngIf="showFooter">
    <ng-container *ngTemplateOutlet="diagramFooter"></ng-container>
  </ng-container>
</ng-template>

<ng-template #diagramTypeNav>
  <div
    class="mb-3"
    [ngClass]="{
      'me-auto': showMetadataButton || showFullScreenButton
    }"
  >
    <div
      [ngClass]="{
        'me-3': showMetadataButton || showFullScreenButton
      }"
    >
      <fhi-diagram-type-nav-default
        [diagramTypeGroups]="diagramTypeGroups"
        (diagramTypeNavigation)="onDiagramTypeNavigation($event)"
      >
      </fhi-diagram-type-nav-default>
    </div>
  </div>
</ng-template>

<ng-template #diagramModal>
  <fhi-modal
    [openModalButtonClass]="'fhi-btn-icon fhi-btn-icon--circular mb-3'"
    [modalTitle]="diagramOptions.title"
    [size]="'fullscreen'"
  >
    <ng-container fhi-modal.button>
      <i class="icon-arrows-fullscreen"></i>
      <span class="visually-hidden">Fullskjerm </span>
    </ng-container>
    <ng-container fhi-modal.body>
      <ng-container *ngTemplateOutlet="diagramTypeNav"></ng-container>
      <ng-container *ngTemplateOutlet="diagramAndFooter"></ng-container>
    </ng-container>
  </fhi-modal>
</ng-template>

<ng-template #metadataLink>
  <button
    class="btn fhi-btn-icon fhi-highcharts-nav__meta-btn mb-3"
    [ngClass]="{
      'fhi-highcharts-nav__meta-btn--push-end': showFullScreenButton
    }"
    (click)="onMetadataButtonClick()"
  >
    <i class="icon-info-circle"></i>
    <span class="btn__text">Om dataene</span>
  </button>
</ng-template>

<ng-template #chart>
  <highcharts-chart class="fhi-highcharts-chart" [Highcharts]="highcharts" [options]="highchartsOptions">
  </highcharts-chart>
</ng-template>

<ng-template #map>
  <highcharts-chart
    class="fhi-highcharts-map"
    [Highcharts]="highmaps"
    [constructorType]="'mapChart'"
    [options]="highchartsOptions"
  >
  </highcharts-chart>
</ng-template>

<ng-template #table>
  <div class="table-responsive pt-3">
    <table class="table table-striped table-sm">
      <thead>
        <tr *ngFor="let headerRow of tableData.theadRows">
          <ng-container *ngFor="let tableCell of headerRow; let i = index">
            <ng-container *ngIf="tableCell">
              <td
                class="text-center"
                [attr.colspan]="tableCell.colspan ? tableCell.colspan : null"
                [attr.rowspan]="tableCell.rowspan ? tableCell.rowspan : null"
                *ngIf="!tableCell.isHeading; else tableHeaderCell"
              ></td>
              <ng-template #tableHeaderCell>
                <th
                  class="text-center"
                  [attr.style]="'width: calc(100% /' + (headerRow.length - 1) + ');'"
                  [attr.colspan]="tableCell.colspan ? tableCell.colspan : null"
                  scope="col"
                  *ngIf="tableCell.isHeading && tableCell.name !== undefined"
                >
                  {{ tableCell.name }}
                </th>
              </ng-template>
            </ng-container>
          </ng-container>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let tableRow of tableData.tbodyRows">
          <ng-container *ngFor="let tableCell of tableRow; let i = index">
            <th
              class="text-nowrap text-start"
              [attr.rowspan]="tableCell.rowspan ? tableCell.rowspan : null"
              scope="row"
              *ngIf="tableCell.isHeading && tableCell.name !== undefined"
            >
              {{ tableCell.name }}
            </th>
            <td class="text-end" *ngIf="!tableCell.isHeading">
              <ng-container *ngIf="tableCellDataOK(tableCell.data); else tableCellDataIsString">
                {{ tableCell.data | number: seriesInfo.digitsInfo }}
              </ng-container>
              <ng-template #tableCellDataIsString>
                {{ tableCell.data }}
              </ng-template>
            </td>
          </ng-container>
        </tr>
      </tbody>
    </table>
  </div>
</ng-template>

<ng-template #diagramFooter>
  <footer class="mt-3">
    <p *ngIf="diagramOptions.footer?.lastUpdated">
      <strong>Sist oppdatert </strong>{{ diagramOptions.footer?.lastUpdated }}
    </p>
    <p *ngIf="diagramOptions.footer?.credits">
      <strong>Kilde </strong>
      <a href="{{ diagramOptions.footer.credits.href }}">{{ diagramOptions.footer.credits.text }}</a>
    </p>
    <div
      class="mb-3"
      *ngIf="diagramOptions.footer?.flags && activeDiagramTypeGroup?.name === diagramTypeGroupNames?.table"
    >
      <strong>Tegnforklaringer</strong><br />
      <table>
        <tbody>
          <tr *ngFor="let flag of diagramOptions.footer?.flags">
            <td class="pe-2">{{ flag.symbol }}</td>
            <td>{{ flag.label }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div
      class="mb-3"
      *ngIf="
        seriesInfo.flaggedSeries.length > 0 &&
        diagramOptions.footer?.flags &&
        activeDiagramTypeGroup?.name !== diagramTypeGroupNames?.table
      "
    >
      <p>
        <a
          role="button"
          class="fhi-popover-trigger"
          tabindex="0"
          triggers="manual"
          #p="ngbPopover"
          aria-haspopup="true"
          (click)="p.toggle()"
          (keydown.enter)="p.toggle()"
          [autoClose]="'outside'"
          [ngbPopover]="popContent"
          >Diagrammet inneholder data som ikke kan vises</a
        >
      </p>
      <ng-template #popContent>
        <p>Følgende data vises ikke i diagrammet</p>
        <ul>
          <li *ngFor="let dataPoint of getFlaggedDataPoints()">{{ dataPoint }} <br /></li>
        </ul>
      </ng-template>
      <a role="button" class="fhi-link" tabindex="0" (click)="setDiagramTypeGroupToTable()">Vis som tabell</a>
      for å se flere detaljer.
    </div>
    <p class="fst-italic small" *ngIf="diagramOptions.footer?.disclaimer">
      {{ diagramOptions.footer?.disclaimer }}
    </p>
    <p>
      <a class="highcharts-credits" href="{{ getMapCopyright()['url'] }}" *ngIf="!diagramOptions.openSource && showMap"
        >Kartdata fra &#169; {{ getMapCopyright()['text'] }}</a
      >
    </p>
  </footer>
</ng-template>

<ng-template #diagramTypeDisabledWarning>
  <div class="mt-3" id="om-dataene">
    <div class="alert alert-warning" role="alert">
      <i class="icon-bell"></i>
      <p class="mb-0">
        Diagramtypen kan ikke vises med dette filtervalget.<br />
        Velg en annen diagramtype eller gjør et annet filtervalg.
      </p>
    </div>
  </div>
</ng-template>

<ng-template #duplicateSerieNameError>
  <div class="mt-3" id="om-dataene">
    <div class="alert alert-error" role="alert">
      <i class="icon-exclamation-circle"></i>
      <p class="mb-0">Det finnes duplikate serienavn, diagrammet kan ikke vises.</p>
    </div>
  </div>
</ng-template>
