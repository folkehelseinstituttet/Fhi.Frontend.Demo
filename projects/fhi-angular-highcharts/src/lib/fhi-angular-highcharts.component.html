<article *ngIf="diagramOptions !== undefined">
  <h1 class="h3 mb-3">{{ diagramOptions.title }}</h1>

  @if (showDiagramTypeNav || showDownloadButton || showFullScreenButton || showMetadataButton) {
    <ng-container *ngTemplateOutlet="diagramControls"></ng-container>
  }
  @if (showDiagramTypeDisabledWarning) {
    <ng-container *ngTemplateOutlet="diagramTypeDisabledWarning"></ng-container>
  } @else if (showDuplicateSerieNameError) {
    <ng-container *ngTemplateOutlet="duplicateSerieNameError"></ng-container>
  } @else {
    <ng-container *ngTemplateOutlet="diagramAndFooter"></ng-container>
  }
</article>

<ng-template #diagramAndFooter>
  <ng-container [ngSwitch]="activeDiagramTypeGroup?.name">
    <ng-container *ngSwitchCase="diagramTypeGroupNames?.table">
      <ng-container *ngTemplateOutlet="table"></ng-container>
    </ng-container>
    <ng-container *ngSwitchCase="diagramTypeGroupNames?.map">
      <ng-container *ngIf="showMap">
        <ng-container *ngTemplateOutlet="map"></ng-container>
      </ng-container>
    </ng-container>
    <ng-container *ngSwitchCase="diagramTypeGroupNames?.chart">
      <ng-container *ngIf="showDefaultChartTemplate; else chartAnimationHack">
        <ng-container *ngTemplateOutlet="chart"></ng-container>
      </ng-container>
      <!-- chartAnimationHack: to get correct chart animation when switching from one chart type to another -->
      <ng-template #chartAnimationHack>
        <ng-container *ngTemplateOutlet="chart"></ng-container>
      </ng-template>
    </ng-container>
  </ng-container>
  <ng-container *ngIf="showFooter">
    <ng-container *ngTemplateOutlet="diagramFooter"></ng-container>
  </ng-container>
</ng-template>

<ng-template #diagramControls>
  <div class="d-flex fhi-diagram-controls">
    <div class="d-flex flex-wrap me-3">
      <div class="fhi-diagram-controls__navigation" *ngIf="showDiagramTypeNav">
        <fhi-diagram-type-nav-default
          [diagramTypeGroups]="diagramTypeGroups"
          (diagramTypeNavigation)="onDiagramTypeNavigation($event)"
        ></fhi-diagram-type-nav-default>
      </div>
      <div class="mb-3">
        <button
          class="btn fhi-btn-icon fhi-diagram-controls__metadata"
          *ngIf="showMetadataButton"
          (click)="onMetadataButtonClick()"
        >
          <i class="icon-info-circle"></i>
          <span class="btn__text">Om dataene</span>
        </button>
        <ng-container *ngIf="showFullScreenButton && !showDiagramTypeDisabledWarning">
          <ng-container *ngTemplateOutlet="diagramModal"></ng-container>
        </ng-container>
      </div>
    </div>
    <div class="ms-auto">
      <fhi-popover-menu
        *ngIf="showDownloadButton"
        [items]="[{ name: 'Last ned SVG', action: 'downloadSvg', icon: 'download' }]"
        (actionEvent)="onControlsPopoverMenuAction($event)"
      ></fhi-popover-menu>
    </div>
  </div>
</ng-template>

<ng-template #diagramModal>
  <fhi-modal
    [openModalButtonClass]="'fhi-btn-icon fhi-btn-icon--circular'"
    [modalTitle]="diagramOptions.title"
    [size]="'fullscreen'"
  >
    <ng-container fhi-modal.button>
      <i class="icon-arrows-fullscreen"></i>
      <span class="visually-hidden">Fullskjerm </span>
    </ng-container>
    <ng-container fhi-modal.body>
      <ng-container *ngTemplateOutlet="diagramAndFooter"></ng-container>
    </ng-container>
  </fhi-modal>
</ng-template>

<ng-template #chart>
  <div class="fhi-highcharts-chart">
    <highcharts-chart
      [Highcharts]="highcharts"
      [options]="highchartsOptions"
      (chartInstance)="onChartInstance($event)"
    ></highcharts-chart>
  </div>
</ng-template>

<ng-template #map>
  <div class="fhi-highcharts-map">
    <highcharts-chart
      [Highcharts]="highmaps"
      [constructorType]="'mapChart'"
      [options]="highchartsOptions"
      (chartInstance)="onChartInstance($event)"
    ></highcharts-chart>
  </div>
</ng-template>

<ng-template #table>
  <div class="table-responsive pt-3">
    <table class="table table-striped table-sm">
      <thead>
        <tr *ngFor="let headerRow of tableData.theadRows">
          <ng-container *ngFor="let tableCell of headerRow; let i = index">
            <ng-container *ngIf="tableCell">
              <td
                class="text-center"
                [attr.colspan]="tableCell.colspan ? tableCell.colspan : null"
                [attr.rowspan]="tableCell.rowspan ? tableCell.rowspan : null"
                *ngIf="!tableCell.isHeading; else tableHeaderCell"
              ></td>
              <ng-template #tableHeaderCell>
                <th
                  class="text-center"
                  [attr.style]="'width: calc(100% /' + (headerRow.length - 1) + ');'"
                  [attr.colspan]="tableCell.colspan ? tableCell.colspan : null"
                  scope="col"
                  *ngIf="tableCell.isHeading && tableCell.name !== undefined"
                >
                  {{ tableCell.name }}
                </th>
              </ng-template>
            </ng-container>
          </ng-container>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let tableRow of tableData.tbodyRows">
          <ng-container *ngFor="let tableCell of tableRow; let i = index">
            <th
              class="text-nowrap text-start"
              [attr.rowspan]="tableCell.rowspan ? tableCell.rowspan : null"
              scope="row"
              *ngIf="tableCell.isHeading && tableCell.name !== undefined"
            >
              {{ tableCell.name }}
            </th>
            <td class="text-end" *ngIf="!tableCell.isHeading">
              <ng-container *ngIf="tableCellDataOK(tableCell.data); else tableCellDataIsString">
                {{ tableCell.data | number: '1.0-' + tableCell.decimals }}
              </ng-container>
              <ng-template #tableCellDataIsString>
                {{ tableCell.data }}
              </ng-template>
            </td>
          </ng-container>
        </tr>
      </tbody>
    </table>
  </div>
</ng-template>

<ng-template #diagramFooter>
  <footer class="mt-3">
    <p *ngIf="diagramOptions.units?.length > 0 && activeDiagramTypeGroup?.name === diagramTypeGroupNames?.table">
      <strong>Måltall </strong>
      <span>
        @for (unit of diagramOptions.units; track unit; let i = $index) {
          <ng-container *ngIf="i === 0">{{ unit.label }}</ng-container>
          <ng-container *ngIf="i > 0">, {{ unit.label }}</ng-container>
        }
      </span>
    </p>
    <p *ngIf="diagramOptions.footer?.lastUpdated">
      <strong>Sist oppdatert </strong>{{ diagramOptions.footer?.lastUpdated }}
    </p>
    <p *ngIf="diagramOptions.footer?.credits">
      <strong>Kilde </strong>
      <a href="{{ diagramOptions.footer.credits.href }}">{{ diagramOptions.footer.credits.text }}</a>
    </p>
    <div
      class="mb-3"
      *ngIf="diagramOptions.footer?.flags && activeDiagramTypeGroup?.name === diagramTypeGroupNames?.table"
    >
      <strong>Tegnforklaringer</strong><br />
      <table>
        <tbody>
          <tr *ngFor="let flag of diagramOptions.footer?.flags">
            <td class="pe-2">{{ flag.symbol }}</td>
            <td>{{ flag.label }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div
      class="mb-3"
      *ngIf="
        flaggedSeries.length > 0 &&
        diagramOptions.footer?.flags &&
        activeDiagramTypeGroup?.name !== diagramTypeGroupNames?.table
      "
    >
      <p>
        <a
          role="button"
          class="fhi-popover-trigger"
          tabindex="0"
          triggers="manual"
          #p="ngbPopover"
          aria-haspopup="true"
          (click)="p.toggle()"
          (keydown.enter)="p.toggle()"
          [autoClose]="'outside'"
          [ngbPopover]="popContent"
          >Diagrammet inneholder data som ikke kan vises</a
        >
      </p>
      <ng-template #popContent>
        <p>Følgende data vises ikke i diagrammet</p>
        <ul>
          <li *ngFor="let dataPoint of getFlaggedDataPoints()">{{ dataPoint }} <br /></li>
        </ul>
      </ng-template>
      <a role="button" class="fhi-link" tabindex="0" (click)="setDiagramTypeGroupToTable()">Vis som tabell</a>
      for å se flere detaljer.
    </div>
    <p class="fst-italic small" *ngIf="diagramOptions.footer?.disclaimer">
      {{ diagramOptions.footer?.disclaimer }}
    </p>
    <p>
      <a class="highcharts-credits" href="{{ getMapCopyright()['url'] }}" *ngIf="!diagramOptions.openSource && showMap"
        >Kartdata fra &#169; {{ getMapCopyright()['text'] }}</a
      >
    </p>
  </footer>
</ng-template>

<ng-template #diagramTypeDisabledWarning>
  <div class="mt-3" id="om-dataene">
    <div class="alert alert-warning" role="alert">
      <i class="icon-bell"></i>
      <p class="mb-0">
        Diagramtypen kan ikke vises med dette filtervalget.<br />
        Velg en annen diagramtype eller gjør et annet filtervalg.
      </p>
    </div>
  </div>
</ng-template>

<ng-template #duplicateSerieNameError>
  <div class="mt-3" id="om-dataene">
    <div class="alert alert-error" role="alert">
      <i class="icon-exclamation-circle"></i>
      <p class="mb-0">Det finnes duplikate serienavn, diagrammet kan ikke vises.</p>
    </div>
  </div>
</ng-template>
